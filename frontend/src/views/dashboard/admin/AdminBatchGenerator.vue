<template>
    <div class="admin-batch-generator">
        <!-- È°µÈù¢Â§¥ÈÉ® -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="max-w-6xl mx-auto">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">üìã ÊâπÈáèPPTÁîüÊàê</h1>
                        <p class="text-gray-600 mt-1">‰∏ÄÊ¨°ÊÄß‰∏∫Â§ö‰∏™Áü•ËØÜÂ∫ìÊñáÊ°£ÁîüÊàêPPT</p>
                    </div>
                    <Button 
                        label="ËøîÂõûÁîüÊàê‰∏≠ÂøÉ" 
                        icon="pi pi-arrow-left" 
                        outlined 
                        @click="router.push('/admin/slides')"
                    />
                </div>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
        <div class="flex-1 bg-gray-50 p-6">
            <div class="max-w-6xl mx-auto space-y-6">
                
                <!-- ÈÖçÁΩÆÊ≠•È™§ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Â∑¶‰æßÔºöÈÖçÁΩÆÈù¢Êùø -->
                    <Card>
                        <template #title>
                            <div class="flex items-center gap-2">
                                <i class="pi pi-cog text-blue-500"></i>
                                ÊâπÈáèÁîüÊàêÈÖçÁΩÆ
                            </div>
                        </template>
                        <template #content>
                            <div class="space-y-4">
                                
                                <!-- Áü•ËØÜÂ∫ìÈÄâÊã© -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ÈÄâÊã©Áü•ËØÜÂ∫ìÊñáÊ°£
                                    </label>
                                    <MultiSelect 
                                        v-model="selectedKnowledge"
                                        :options="knowledgeOptions"
                                        optionLabel="title"
                                        optionValue="id"
                                        placeholder="ÈÄâÊã©Ë¶ÅÁîüÊàêPPTÁöÑÁü•ËØÜÂ∫ìÊñáÊ°£"
                                        :filter="true"
                                        class="w-full"
                                        :loading="loading.knowledge"
                                    >
                                        <template #option="slotProps">
                                            <div class="flex items-center gap-2">
                                                <i class="pi pi-file-pdf text-red-500"></i>
                                                <div>
                                                    <div class="font-medium">{{ slotProps.option.title }}</div>
                                                    <div class="text-xs text-gray-500">{{ slotProps.option.summary }}</div>
                                                </div>
                                            </div>
                                        </template>
                                    </MultiSelect>
                                </div>

                                <!-- ‰∏ªÈ¢òÈÄâÊã© -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        PPT‰∏ªÈ¢ò
                                    </label>
                                    <Select 
                                        v-model="batchConfig.theme"
                                        :options="themeOptions"
                                        optionLabel="name"
                                        optionValue="name"
                                        placeholder="ÈÄâÊã©PPT‰∏ªÈ¢ò"
                                        class="w-full"
                                    />
                                </div>

                                <!-- ÁîüÊàêÂèÇÊï∞ -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            ÂπªÁÅØÁâáÊï∞Èáè
                                        </label>
                                        <InputNumber 
                                            v-model="batchConfig.slideCount"
                                            :min="5"
                                            :max="50"
                                            class="w-full"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            ÁîüÊàêËØ≠Ë®Ä
                                        </label>
                                        <Select 
                                            v-model="batchConfig.language"
                                            :options="languageOptions"
                                            optionLabel="label"
                                            optionValue="value"
                                            class="w-full"
                                        />
                                    </div>
                                </div>

                                <!-- È´òÁ∫ßÈÄâÈ°π -->
                                <Accordion>
                                    <AccordionTab header="È´òÁ∫ßÈÄâÈ°π">
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-2">
                                                <Checkbox 
                                                    v-model="batchConfig.includeImages"
                                                    inputId="includeImages"
                                                    :binary="true"
                                                />
                                                <label for="includeImages" class="text-sm">ÂåÖÂê´ÂõæÁâá</label>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <Checkbox 
                                                    v-model="batchConfig.autoExport"
                                                    inputId="autoExport"
                                                    :binary="true"
                                                />
                                                <label for="autoExport" class="text-sm">ÁîüÊàêÂêéËá™Âä®ÂØºÂá∫PDF</label>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <Checkbox 
                                                    v-model="batchConfig.sendNotification"
                                                    inputId="sendNotification"
                                                    :binary="true"
                                                />
                                                <label for="sendNotification" class="text-sm">ÂÆåÊàêÂêéÂèëÈÄÅÈÄöÁü•</label>
                                            </div>
                                        </div>
                                    </AccordionTab>
                                </Accordion>

                                <!-- Êìç‰ΩúÊåâÈíÆ -->
                                <div class="flex gap-3">
                                    <Button 
                                        label="ÂºÄÂßãÊâπÈáèÁîüÊàê"
                                        icon="pi pi-play"
                                        @click="startBatchGeneration"
                                        :disabled="selectedKnowledge.length === 0 || isGenerating"
                                        :loading="isGenerating"
                                        class="flex-1"
                                    />
                                    <Button 
                                        label="ÈáçÁΩÆÈÖçÁΩÆ"
                                        icon="pi pi-refresh"
                                        outlined
                                        @click="resetConfig"
                                    />
                                </div>
                            </div>
                        </template>
                    </Card>

                    <!-- Âè≥‰æßÔºöÈ¢ÑËßàÂíåÁä∂ÊÄÅ -->
                    <Card>
                        <template #title>
                            <div class="flex items-center gap-2">
                                <i class="pi pi-eye text-green-500"></i>
                                ÁîüÊàêÈ¢ÑËßà
                            </div>
                        </template>
                        <template #content>
                            <div class="space-y-4">
                                
                                <!-- ÁîüÊàêÈ¢ÑËßà -->
                                <div v-if="selectedKnowledge.length > 0">
                                    <div class="text-sm text-gray-600 mb-3">
                                        Â∞ÜÁîüÊàê {{ selectedKnowledge.length }} ‰∏™PPTÈ°πÁõÆ
                                    </div>
                                    <div class="space-y-2 max-h-64 overflow-y-auto">
                                        <div 
                                            v-for="knowledgeId in selectedKnowledge" 
                                            :key="knowledgeId"
                                            class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
                                        >
                                            <div class="flex items-center gap-2">
                                                <i class="pi pi-file-pdf text-red-500"></i>
                                                <span class="text-sm">{{ getKnowledgeTitle(knowledgeId) }}</span>
                                            </div>
                                            <Tag :value="`${batchConfig.slideCount} È°µ`" />
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-else class="text-center py-8 text-gray-500">
                                    <i class="pi pi-info-circle text-4xl mb-3"></i>
                                    <p>ËØ∑ÈÄâÊã©Áü•ËØÜÂ∫ìÊñáÊ°£ÂºÄÂßãÈÖçÁΩÆ</p>
                                </div>
                            </div>
                        </template>
                    </Card>
                </div>

                <!-- ÁîüÊàêËøõÂ∫¶ -->
                <Card v-if="isGenerating || generationResults.length > 0">
                    <template #title>
                        <div class="flex items-center gap-2">
                            <i class="pi pi-cog" :class="{ 'pi-spin': isGenerating }"></i>
                            ÁîüÊàêËøõÂ∫¶
                        </div>
                    </template>
                    <template #content>
                        <div class="space-y-4">
                            
                            <!-- ÊÄª‰ΩìËøõÂ∫¶ -->
                            <div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span>ÊÄª‰ΩìËøõÂ∫¶</span>
                                    <span>{{ completedCount }}/{{ totalCount }}</span>
                                </div>
                                <ProgressBar 
                                    :value="overallProgress"
                                    :showValue="false"
                                />
                            </div>

                            <!-- ËØ¶ÁªÜËøõÂ∫¶ -->
                            <DataTable 
                                :value="generationResults"
                                class="mt-4"
                            >
                                <Column field="title" header="È°πÁõÆÂêçÁß∞"></Column>
                                <Column field="status" header="Áä∂ÊÄÅ">
                                    <template #body="slotProps">
                                        <Tag 
                                            :value="getStatusLabel(slotProps.data.status)"
                                            :severity="getStatusSeverity(slotProps.data.status)"
                                        />
                                    </template>
                                </Column>
                                <Column field="progress" header="ËøõÂ∫¶">
                                    <template #body="slotProps">
                                        <ProgressBar 
                                            :value="slotProps.data.progress"
                                            :showValue="false"
                                            style="height: 6px"
                                        />
                                    </template>
                                </Column>
                                <Column header="Êìç‰Ωú">
                                    <template #body="slotProps">
                                        <div class="flex gap-2">
                                            <Button 
                                                v-if="slotProps.data.status === 'completed'"
                                                icon="pi pi-eye"
                                                text
                                                @click="previewResult(slotProps.data)"
                                                title="È¢ÑËßà"
                                            />
                                            <Button 
                                                v-if="slotProps.data.status === 'completed'"
                                                icon="pi pi-download"
                                                text
                                                @click="downloadResult(slotProps.data)"
                                                title="‰∏ãËΩΩ"
                                            />
                                        </div>
                                    </template>
                                </Column>
                            </DataTable>
                        </div>
                    </template>
                </Card>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useAuthStore } from '@/store/auth';
import axios from 'axios';
import { API_BASE_URL } from '@/utils/api';

// PrimeVue ÁªÑ‰ª∂
import Card from 'primevue/card';
import Button from 'primevue/button';
import MultiSelect from 'primevue/multiselect';
import Select from 'primevue/select';
import InputNumber from 'primevue/inputnumber';
import Checkbox from 'primevue/checkbox';
import Accordion from 'primevue/accordion';
import AccordionTab from 'primevue/accordiontab';
import Tag from 'primevue/tag';
import ProgressBar from 'primevue/progressbar';
import DataTable from 'primevue/datatable';
import Column from 'primevue/column';

const router = useRouter();
const authStore = useAuthStore();

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const selectedKnowledge = ref<number[]>([]);
const knowledgeOptions = ref([]);
const themeOptions = ref([]);
const isGenerating = ref(false);
const generationResults = ref([]);

const loading = ref({
    knowledge: false,
    themes: false
});

const batchConfig = ref({
    theme: 'academic',
    slideCount: 15,
    language: 'zh-CN',
    includeImages: true,
    autoExport: false,
    sendNotification: true
});

const languageOptions = [
    { label: '‰∏≠Êñá', value: 'zh-CN' },
    { label: 'Ëã±Êñá', value: 'en-US' },
    { label: 'Êó•Êñá', value: 'ja-JP' }
];

// ËÆ°ÁÆóÂ±ûÊÄß
const completedCount = computed(() => 
    generationResults.value.filter(r => r.status === 'completed').length
);

const totalCount = computed(() => generationResults.value.length);

const overallProgress = computed(() => 
    totalCount.value > 0 ? (completedCount.value / totalCount.value) * 100 : 0
);

// Ëé∑ÂèñÁü•ËØÜÂ∫ìÂàóË°®
const fetchKnowledge = async () => {
    loading.value.knowledge = true;
    try {
        const response = await axios.get(`${API_BASE_URL}/knowledge`, {
            params: { limit: 100 }
        });
        knowledgeOptions.value = response.data.items || [];
    } catch (error) {
        console.error('Ëé∑ÂèñÁü•ËØÜÂ∫ìÂ§±Ë¥•:', error);
    } finally {
        loading.value.knowledge = false;
    }
};

// Ëé∑Âèñ‰∏ªÈ¢òÂàóË°®
const fetchThemes = async () => {
    loading.value.themes = true;
    try {
        const response = await axios.get(`${API_BASE_URL}/mcp/themes`);
        themeOptions.value = response.data || [];
    } catch (error) {
        console.error('Ëé∑Âèñ‰∏ªÈ¢òÂ§±Ë¥•:', error);
    } finally {
        loading.value.themes = false;
    }
};

// ÂºÄÂßãÊâπÈáèÁîüÊàê
const startBatchGeneration = async () => {
    if (selectedKnowledge.value.length === 0) return;
    
    isGenerating.value = true;
    
    // ÂàùÂßãÂåñÁªìÊûúÊï∞ÁªÑ
    generationResults.value = selectedKnowledge.value.map(knowledgeId => ({
        knowledgeId,
        title: getKnowledgeTitle(knowledgeId),
        status: 'pending',
        progress: 0,
        projectId: null
    }));
    
    // ÈÄê‰∏™ÁîüÊàêPPT
    for (let i = 0; i < generationResults.value.length; i++) {
        const result = generationResults.value[i];
        
        try {
            result.status = 'generating';
            result.progress = 10;
            
            // Ë∞ÉÁî®ÊâπÈáèÁîüÊàêAPI
            const response = await axios.post(`${API_BASE_URL}/admin/slides/batch-generate`, {
                knowledgeId: result.knowledgeId,
                config: batchConfig.value
            });
            
            result.projectId = response.data.projectId;
            result.progress = 50;
            
            // Á≠âÂæÖÁîüÊàêÂÆåÊàê
            await pollGenerationStatus(result);
            
        } catch (error) {
            console.error(`ÁîüÊàêÂ§±Ë¥• - ${result.title}:`, error);
            result.status = 'failed';
            result.progress = 0;
        }
    }
    
    isGenerating.value = false;
    
    // ÂèëÈÄÅÂÆåÊàêÈÄöÁü•
    if (batchConfig.value.sendNotification) {
        showNotification();
    }
};

// ËΩÆËØ¢ÁîüÊàêÁä∂ÊÄÅ
const pollGenerationStatus = async (result: any) => {
    const maxAttempts = 60; // ÊúÄÂ§öÁ≠âÂæÖ10ÂàÜÈíü
    let attempts = 0;
    
    while (attempts < maxAttempts) {
        try {
            const response = await axios.get(
                `${API_BASE_URL}/knowledge-slides/project/${result.projectId}`
            );
            
            const status = response.data.status;
            
            if (status === 'completed') {
                result.status = 'completed';
                result.progress = 100;
                break;
            } else if (status === 'failed') {
                result.status = 'failed';
                result.progress = 0;
                break;
            } else {
                result.progress = Math.min(50 + (attempts * 2), 90);
            }
            
            await new Promise(resolve => setTimeout(resolve, 10000)); // Á≠âÂæÖ10Áßí
            attempts++;
            
        } catch (error) {
            console.error('ËΩÆËØ¢Áä∂ÊÄÅÂ§±Ë¥•:', error);
            break;
        }
    }
    
    if (attempts >= maxAttempts && result.status !== 'completed') {
        result.status = 'timeout';
    }
};

// ÈáçÁΩÆÈÖçÁΩÆ
const resetConfig = () => {
    selectedKnowledge.value = [];
    generationResults.value = [];
    batchConfig.value = {
        theme: 'academic',
        slideCount: 15,
        language: 'zh-CN',
        includeImages: true,
        autoExport: false,
        sendNotification: true
    };
};

// Â∑•ÂÖ∑ÂáΩÊï∞
const getKnowledgeTitle = (knowledgeId: number) => {
    const knowledge = knowledgeOptions.value.find((k: any) => k.id === knowledgeId);
    return knowledge?.title || `Áü•ËØÜÂ∫ì ${knowledgeId}`;
};

const getStatusLabel = (status: string) => {
    const statusMap: { [key: string]: string } = {
        pending: 'Á≠âÂæÖ‰∏≠',
        generating: 'ÁîüÊàê‰∏≠',
        completed: 'Â∑≤ÂÆåÊàê',
        failed: 'ÁîüÊàêÂ§±Ë¥•',
        timeout: 'Ë∂ÖÊó∂'
    };
    return statusMap[status] || status;
};

const getStatusSeverity = (status: string) => {
    const severityMap: { [key: string]: string } = {
        pending: 'info',
        generating: 'warning',
        completed: 'success',
        failed: 'danger',
        timeout: 'danger'
    };
    return severityMap[status] || 'info';
};

const previewResult = async (result: any) => {
    try {
        // ÂÖàËé∑ÂèñÈ¢ÑËßàÁ´ØÂè£
        const response = await axios.get(`${API_BASE_URL}/knowledge-slides/project/${result.projectId}/preview-port`);
        
        if (response.data.success && response.data.data?.port) {
            const previewUrl = `http://localhost:${response.data.data.port}`;
            window.open(previewUrl, '_blank');
        } else {
            throw new Error(response.data.error || 'Ëé∑ÂèñÈ¢ÑËßàÁ´ØÂè£Â§±Ë¥•');
        }
    } catch (error) {
        console.error('ÂêØÂä®È¢ÑËßàÂ§±Ë¥•:', error);
        alert('Êó†Ê≥ïÂêØÂä®SlidevÈ¢ÑËßàÊúçÂä°');
    }
};

const downloadResult = async (result: any) => {
    try {
        const response = await axios.post(
            `${API_BASE_URL}/knowledge-slides/project/${result.projectId}/export`,
            { format: 'pdf' }
        );
        // Â§ÑÁêÜ‰∏ãËΩΩ
        console.log('‰∏ãËΩΩÈ°πÁõÆ:', result.title);
    } catch (error) {
        console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
    }
};

const showNotification = () => {
    // ÊòæÁ§∫ÂÆåÊàêÈÄöÁü•
    console.log('ÊâπÈáèÁîüÊàêÂÆåÊàêÔºÅ');
};

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
    // ÊùÉÈôêÊ£ÄÊü•
    if (authStore.user?.role !== 'admin') {
        router.push('/dashboard');
        return;
    }
    
    // Âπ∂Ë°åËé∑ÂèñÊï∞ÊçÆ
    await Promise.all([
        fetchKnowledge(),
        fetchThemes()
    ]);
});
</script>

<style scoped>
.admin-batch-generator {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}
</style>