<template>
    <div class="integrated-ppt-generator">
        <!-- ÈÖçÁΩÆÈò∂ÊÆµ -->
        <div v-if="currentStage === 'config'" class="config-stage">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ü§ñ Êô∫ËÉΩPPTÁîüÊàê</h2>
                
                <!-- Ë°®ÂçïÂå∫Âüü -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Â∑¶‰æßÔºöÂü∫Êú¨ÈÖçÁΩÆ -->
                    <div class="space-y-6">
                        <div class="field">
                            <label for="title" class="font-medium text-gray-700 mb-2 block">
                                ÊºîÁ§∫Ê†áÈ¢ò <span class="text-red-500">*</span>
                            </label>
                            <InputText
                                id="title"
                                v-model="slideRequest.title"
                                placeholder="‰æãÂ¶ÇÔºöVue.js 3 ÊúÄ‰Ω≥ÂÆûË∑µÂàÜ‰∫´"
                                class="w-full"
                                :class="{ 'p-invalid': formErrors.title }"
                                @input="validateField('title')"
                            />
                            <small v-if="formErrors.title" class="p-error">{{ formErrors.title }}</small>
                        </div>

                        <div class="field">
                            <label for="topic" class="font-medium text-gray-700 mb-2 block">
                                ‰∏ªÈ¢òÂÖ≥ÈîÆËØç <span class="text-red-500">*</span>
                            </label>
                            <Textarea
                                id="topic"
                                v-model="slideRequest.topic"
                                placeholder="‰æãÂ¶ÇÔºöVueÁªÑ‰ª∂ËÆæËÆ° ÂìçÂ∫îÂºèÁºñÁ®ã ÊÄßËÉΩ‰ºòÂåñ"
                                rows="3"
                                class="w-full"
                                :class="{ 'p-invalid': formErrors.topic }"
                                @input="validateField('topic')"
                            />
                            <small v-if="formErrors.topic" class="p-error">{{ formErrors.topic }}</small>
                        </div>

                        <div class="field">
                            <label for="requirements" class="font-medium text-gray-700 mb-2 block">
                                ÂÖ∑‰ΩìÈúÄÊ±Ç
                            </label>
                            <Textarea
                                id="requirements"
                                v-model="slideRequest.requirements"
                                placeholder="‰æãÂ¶ÇÔºöÂåÖÂê´ÂÆûÈôÖ‰ª£Á†ÅÁ§∫‰æãÔºåÈáçÁÇπ‰ªãÁªçÊúÄÊñ∞ÁâπÊÄß"
                                rows="4"
                                class="w-full"
                            />
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="field">
                                <label class="font-medium text-gray-700 mb-2 block">ÂπªÁÅØÁâáÊï∞Èáè</label>
                                <InputNumber v-model="slideRequest.slideCount" :min="5" :max="30" class="w-full" />
                            </div>
                            <div class="field">
                                <label class="font-medium text-gray-700 mb-2 block">‰∏ªÈ¢òÊ†∑Âºè</label>
                                <Dropdown
                                    v-model="slideRequest.theme"
                                    :options="themeOptions"
                                    option-label="label"
                                    option-value="value"
                                    class="w-full"
                                />
                            </div>
                        </div>

                        <!-- Êìç‰ΩúÊåâÈíÆ -->
                        <div class="flex justify-between items-center pt-4">
                            <div class="flex space-x-2">
                                <Button label="Âä†ËΩΩÁ§∫‰æã" icon="pi pi-file" outlined @click="addExample" />
                                <Button 
                                    label="È°πÁõÆÁÆ°ÁêÜ" 
                                    icon="pi pi-folder" 
                                    outlined 
                                    @click="goToManager" 
                                />
                            </div>
                            <Button
                                label="ÁîüÊàêPPT"
                                icon="pi pi-cog"
                                :loading="isGenerating"
                                :disabled="!canProceed"
                                @click="generatePPT"
                                class="px-8"
                            />
                        </div>
                    </div>

                    <!-- Âè≥‰æßÔºöÁü•ËØÜÂ∫ìÁªüËÆ° -->
                    <div class="space-y-6">
                        <Card class="shadow-sm">
                            <template #title>
                                <div class="flex items-center">
                                    <i class="pi pi-database text-blue-500 mr-2"></i>
                                    Áü•ËØÜÂ∫ìÁªüËÆ°
                                </div>
                            </template>
                            <template #content>
                                <div v-if="knowledgeStats" class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">ÊÄªÊñáÊ°£Êï∞</span>
                                        <span class="font-semibold">{{ knowledgeStats.totalDocuments }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Â∑≤ÂêëÈáèÂåñ</span>
                                        <span class="font-semibold text-green-600">{{ knowledgeStats.vectorizedDocuments }}</span>
                                    </div>
                                </div>
                            </template>
                        </Card>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â§ßÁ∫≤Á°ÆËÆ§Èò∂ÊÆµ -->
        <div v-else-if="currentStage === 'outline'" class="outline-stage">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üìã Â§ßÁ∫≤Á°ÆËÆ§</h2>
                    <div class="flex space-x-2">
                        <Button label="ÈáçÊñ∞ÁîüÊàê" icon="pi pi-refresh" outlined @click="regenerateOutline" />
                        <Button
                            label="Á°ÆËÆ§ÁîüÊàê"
                            icon="pi pi-check"
                            :loading="isGeneratingFinal"
                            @click="confirmAndGenerate"
                        />
                    </div>
                </div>

                <div v-if="generatedOutline" class="space-y-4">
                    <!-- Â§ßÁ∫≤Ê¶ÇËßà -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center bg-blue-50 p-4 rounded">
                            <div class="text-2xl font-bold text-blue-600">{{ generatedOutline.totalSlides }}</div>
                            <div class="text-sm text-gray-600">ÊÄªÂπªÁÅØÁâáÊï∞</div>
                        </div>
                        <div class="text-center bg-green-50 p-4 rounded">
                            <div class="text-2xl font-bold text-green-600">{{ generatedOutline.usedKnowledge.length }}</div>
                            <div class="text-sm text-gray-600">ÂèÇËÄÉÊñáÊ°£Êï∞</div>
                        </div>
                        <div class="text-center bg-purple-50 p-4 rounded">
                            <div class="text-2xl font-bold text-purple-600">{{ generatedOutline.slides.length }}</div>
                            <div class="text-sm text-gray-600">ÂÜÖÂÆπÈ°µÊï∞</div>
                        </div>
                    </div>

                    <!-- ÂπªÁÅØÁâáÂàóË°® -->
                    <div class="space-y-3">
                        <div
                            v-for="(slide, index) in generatedOutline.slides"
                            :key="index"
                            class="border rounded-lg p-4 hover:shadow-md transition-shadow"
                        >
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">
                                        Á¨¨ {{ index + 1 }} È°µ
                                    </span>
                                    <h4 class="font-medium text-gray-900">{{ slide.title }}</h4>
                                </div>
                                <Button icon="pi pi-pencil" text @click="editSlide(index)" />
                            </div>
                            <p class="text-sm text-gray-600 line-clamp-2">{{ slide.content }}</p>
                        </div>
                    </div>
                </div>

                <div v-else-if="isGenerating" class="text-center py-12">
                    <ProgressSpinner style="width: 50px; height: 50px" />
                    <h3 class="text-lg font-medium text-gray-900 mt-4">Ê≠£Âú®ÁîüÊàêÂ§ßÁ∫≤...</h3>
                </div>
            </div>
        </div>

        <!-- ÂÆåÊàêÈò∂ÊÆµ -->
        <div v-else-if="currentStage === 'complete'" class="complete-stage">
            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <i class="pi pi-check-circle text-6xl text-green-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">üéâ PPTÁîüÊàêÂÆåÊàêÔºÅ</h2>
                <p class="text-gray-600 mb-6">ÊÇ®ÁöÑÊºîÁ§∫ÊñáÁ®øÂ∑≤ÊàêÂäüÁîüÊàê</p>

                <div class="flex justify-center space-x-4 mb-6">
                    <Button 
                        label="‰∏ãËΩΩMarkdownÊñá‰ª∂" 
                        icon="pi pi-download" 
                        @click="downloadMarkdown" 
                        class="px-6"
                    />
                    <Button 
                        label="ËøîÂõûÈ¶ñÈ°µ" 
                        icon="pi pi-home" 
                        outlined 
                        @click="goHome" 
                        class="px-6"
                    />
                </div>

                <!-- ‰ΩøÁî®ÊåáÂçó -->
                <Card class="max-w-lg mx-auto mt-6">
                    <template #title>
                        <i class="pi pi-info-circle text-blue-500 mr-2"></i>
                        ‰ΩøÁî®ÊåáÂçó
                    </template>
                    <template #content>
                        <div class="text-left space-y-2 text-sm">
                            <p><strong>1. ÂÆâË£Ö Slidev:</strong></p>
                            <p class="bg-gray-100 p-2 rounded font-mono text-xs">npm install -g @slidev/cli</p>
                            
                            <p><strong>2. ËøêË°åÊºîÁ§∫:</strong></p>
                            <p class="bg-gray-100 p-2 rounded font-mono text-xs">slidev your-presentation.md</p>
                            
                            <p><strong>3. ÊâìÂºÄÊµèËßàÂô®È¢ÑËßà</strong></p>
                            <p class="text-gray-600">Á≥ªÁªü‰ºöËá™Âä®Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄÊºîÁ§∫</p>
                            
                            <div class="border-t pt-2 mt-4">
                                <p class="text-xs text-gray-500">
                                    üí° Êõ¥Â§ö‰ø°ÊÅØËØ∑ËÆøÈóÆ 
                                    <a href="https://sli.dev" target="_blank" class="text-blue-500 hover:underline">
                                        https://sli.dev
                                    </a>
                                </p>
                            </div>
                        </div>
                    </template>
                </Card>
            </div>
        </div>

        <!-- ÁºñËæëÂØπËØùÊ°Ü -->
        <Dialog v-model:visible="showEditSlideDialog" header="ÁºñËæëÂπªÁÅØÁâá" :style="{ width: '600px' }" modal>
            <div class="space-y-4">
                <div class="field">
                    <label class="font-medium text-gray-700 mb-2 block">Ê†áÈ¢ò</label>
                    <InputText v-model="editingSlideData.title" class="w-full" />
                </div>
                <div class="field">
                    <label class="font-medium text-gray-700 mb-2 block">ÂÜÖÂÆπ</label>
                    <Textarea v-model="editingSlideData.content" rows="6" class="w-full" />
                </div>
            </div>
            <template #footer>
                <Button label="ÂèñÊ∂à" text @click="showEditSlideDialog = false" />
                <Button label="‰øùÂ≠ò" @click="saveEditedSlide" />
            </template>
        </Dialog>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useToast } from 'primevue/usetoast';
import { v4 as uuidv4 } from 'uuid';
import { knowledgeBasedSlideApi } from '@/api/knowledge-based-slide';
import type { 
    KnowledgeSlideRequest, 
    KnowledgeSlideOutline, 
    KnowledgeStats 
} from '@/api/knowledge-based-slide';
import type { KnowledgeSlidevProject } from '../dto';

// PrimeVue components
import Card from 'primevue/card';
import InputText from 'primevue/inputtext';
import Textarea from 'primevue/textarea';
import InputNumber from 'primevue/inputnumber';
import Dropdown from 'primevue/dropdown';
import Button from 'primevue/button';
import Dialog from 'primevue/dialog';
import ProgressSpinner from 'primevue/progressspinner';
import Message from 'primevue/message';

const router = useRouter();
const toast = useToast();

// ÂΩìÂâçÈò∂ÊÆµ
const currentStage = ref<'config' | 'outline' | 'complete'>('config');

// Ë°®ÂçïÊï∞ÊçÆ
const slideRequest = ref<KnowledgeSlideRequest>({
    title: '',
    topic: '',
    requirements: '',
    targetAudience: '',
    slideCount: 12,
    theme: 'academic'
});

// Áä∂ÊÄÅÁÆ°ÁêÜ
const formErrors = ref<Record<string, string>>({});
const isGenerating = ref(false);
const isGeneratingFinal = ref(false);
const knowledgeStats = ref<KnowledgeStats | null>(null);
const generatedOutline = ref<KnowledgeSlideOutline | null>(null);
const finalProject = ref<KnowledgeSlidevProject | null>(null);

// ÁºñËæëÁä∂ÊÄÅ
const showEditSlideDialog = ref(false);
const editingSlideIndex = ref(-1);
const editingSlideData = ref({ title: '', content: '', keyPoints: [] as string[] });

// ‰∏ªÈ¢òÈÄâÈ°π
const themeOptions = [
    { label: 'Â≠¶ÊúØÈ£éÊ†º', value: 'academic' },
    { label: 'ÈªòËÆ§‰∏ªÈ¢ò', value: 'default' },
    { label: 'ÂïÜÂä°È£éÊ†º', value: 'frankfurt' }
];

// ËÆ°ÁÆóÂ±ûÊÄß
const canProceed = computed(() => {
    return slideRequest.value.title.trim() !== '' &&
           slideRequest.value.topic.trim() !== '' &&
           Object.keys(formErrors.value).length === 0;
});

// Ë°®ÂçïÈ™åËØÅ
const validateForm = () => {
    const errors: Record<string, string> = {};
    if (!slideRequest.value.title.trim()) errors.title = 'ÊºîÁ§∫Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫';
    if (!slideRequest.value.topic.trim()) errors.topic = '‰∏ªÈ¢òÂÖ≥ÈîÆËØç‰∏çËÉΩ‰∏∫Á©∫';
    formErrors.value = errors;
    return Object.keys(errors).length === 0;
};

const validateField = (field: keyof KnowledgeSlideRequest) => {
    const tempErrors = { ...formErrors.value };
    delete tempErrors[field];
    formErrors.value = tempErrors;
    validateForm();
};

// ÁîüÊàêPPT‰∏ªÊµÅÁ®ã
const generatePPT = async () => {
    if (!validateForm()) return;

    isGenerating.value = true;
    currentStage.value = 'outline';

    try {
        const result = await knowledgeBasedSlideApi.generateOutline(slideRequest.value);
        if (result.success) {
            generatedOutline.value = result.data;
            toast.add({
                severity: 'success',
                summary: 'Â§ßÁ∫≤ÁîüÊàêÊàêÂäü',
                detail: `Â∑≤ÁîüÊàêÂåÖÂê´ ${result.data.totalSlides} È°µÁöÑÊºîÁ§∫Â§ßÁ∫≤`
            });
        } else {
            throw new Error(result.error || 'Â§ßÁ∫≤ÁîüÊàêÂ§±Ë¥•');
        }
    } catch (error: any) {
        toast.add({ severity: 'error', summary: 'ÁîüÊàêÂ§±Ë¥•', detail: error.message });
        currentStage.value = 'config';
    } finally {
        isGenerating.value = false;
    }
};

// ÈáçÊñ∞ÁîüÊàêÂ§ßÁ∫≤
const regenerateOutline = async () => {
    generatedOutline.value = null;
    await generatePPT();
};

// Á°ÆËÆ§Âπ∂ÁîüÊàêÊúÄÁªàÂÜÖÂÆπ
const confirmAndGenerate = async () => {
    if (!generatedOutline.value) return;

    isGeneratingFinal.value = true;
    try {
        const slideId = `kb-slide-${uuidv4()}`;
        const result = await knowledgeBasedSlideApi.generateMarkdown({
            outline: generatedOutline.value,
            slideId,
            format: 'slidev'
        });
        
        if (result.success) {
            finalProject.value = {
                id: slideId,
                name: generatedOutline.value.title,
                title: generatedOutline.value.title,
                content: result.data.markdown,
                slides_path: result.data.slides_path,
                theme: slideRequest.value.theme || 'academic',
                status: 'ready'
            };
            currentStage.value = 'complete';
            toast.add({ severity: 'success', summary: 'ÁîüÊàêÂÆåÊàê', detail: 'ÊºîÁ§∫ÊñáÁ®øÂ∑≤ÊàêÂäüÁîüÊàê' });
        } else {
            throw new Error(result.error || 'MarkdownÁîüÊàêÂ§±Ë¥•');
        }
    } catch (error: any) {
        toast.add({ severity: 'error', summary: 'ÁîüÊàêÂ§±Ë¥•', detail: error.message });
    } finally {
        isGeneratingFinal.value = false;
    }
};

// ÁºñËæëÂπªÁÅØÁâá
const editSlide = (index: number) => {
    if (!generatedOutline.value) return;
    const slide = generatedOutline.value.slides[index];
    editingSlideIndex.value = index;
    editingSlideData.value = {
        title: slide.title,
        content: slide.content,
        keyPoints: [...slide.keyPoints]
    };
    showEditSlideDialog.value = true;
};

const saveEditedSlide = () => {
    if (!generatedOutline.value || editingSlideIndex.value < 0) return;
    const slide = generatedOutline.value.slides[editingSlideIndex.value];
    slide.title = editingSlideData.value.title;
    slide.content = editingSlideData.value.content;
    slide.keyPoints = editingSlideData.value.keyPoints;
    showEditSlideDialog.value = false;
    toast.add({ severity: 'success', summary: '‰øùÂ≠òÊàêÂäü', detail: 'ÂπªÁÅØÁâáÂ∑≤Êõ¥Êñ∞' });
};

// ÂÖ∂‰ªñÊìç‰Ωú
const addExample = () => {
    slideRequest.value = {
        title: 'Vue.js 3 ÁªÑ‰ª∂ËÆæËÆ°ÊúÄ‰Ω≥ÂÆûË∑µ',
        topic: 'Vue.js ÁªÑ‰ª∂ ÂìçÂ∫îÂºè Composition API',
        requirements: 'Èù¢ÂêëÊúâVueÂü∫Á°ÄÁöÑÂºÄÂèëËÄÖÔºåÂåÖÂê´ÂÆûÈôÖ‰ª£Á†ÅÁ§∫‰æã',
        targetAudience: 'ÂâçÁ´ØÂºÄÂèëÂ∑•Á®ãÂ∏à',
        slideCount: 12,
        theme: 'academic'
    };
};

const previewPresentation = () => {
    if (finalProject.value) {
        // ‰∏∫Áü•ËØÜÂ∫ìÈ°πÁõÆÂàõÂª∫‰∏¥Êó∂È¢ÑËßà
        const markdown = finalProject.value.content;
        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        
        // ‰∏ãËΩΩÊñá‰ª∂‰æõÁî®Êà∑Êú¨Âú∞È¢ÑËßà
        const a = document.createElement('a');
        a.href = url;
        a.download = `${finalProject.value.name}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        toast.add({
            severity: 'info',
            summary: 'È¢ÑËßàÊñá‰ª∂Â∑≤‰∏ãËΩΩ',
            detail: 'ËØ∑‰ΩøÁî® Slidev CLI Âú®Êú¨Âú∞È¢ÑËßàÔºöslidev ' + `${finalProject.value.name}.md`,
            life: 8000
        });
    }
};

const goHome = () => {
    router.push('/knowledge-slides');
};

// Ë∑≥ËΩ¨Âà∞È°πÁõÆÁÆ°ÁêÜÂô®
const goToManager = () => {
    router.push('/knowledge-slides/manager');
};

// ‰∏ãËΩΩMarkdownÊñá‰ª∂
const downloadMarkdown = () => {
    if (finalProject.value) {
        const blob = new Blob([finalProject.value.content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${finalProject.value.name}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        toast.add({
            severity: 'success',
            summary: '‰∏ãËΩΩÊàêÂäü',
            detail: 'MarkdownÊñá‰ª∂Â∑≤‰∏ãËΩΩÂà∞Êú¨Âú∞'
        });
    }
};

// Âä†ËΩΩÁü•ËØÜÂ∫ìÁªüËÆ°
const loadKnowledgeStats = async () => {
    try {
        const result = await knowledgeBasedSlideApi.getKnowledgeStats();
        if (result.success) {
            knowledgeStats.value = result.data;
        }
    } catch (error) {
        console.error('Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•:', error);
    }
};

onMounted(() => {
    loadKnowledgeStats();
});
</script>

<style scoped>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>